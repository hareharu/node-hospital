# node-hospital

node-hospital это Node.js приложение в помощь сотрудникам медучреждений - от медсестры до системного администратора. В приложении имеется интеграция с ИС Стационар, МИС Госпиталь, ЕИР, реализован удобный поиск в РЗН. Медицинским работникам доступны быстрый и удобный доступ к информации из баз данных, а также формирование целого ряда отчетов. Сотрудникам IT отдела - централизованный мониторинг различных сервисов, модуль для учета оборудования и много другое. Для удобства пользователей предусмотрена возможность авторизации под учетными записями AD и МИС Госпиталь.

Приложение состоит из сервера на фреймворке [Express](https://expressjs.com/) и [React](https://reactjs.org) клиента использующего компоненты интерфейса [Office UI Fabric](https://developer.microsoft.com/en-us/fabric).

## Использование

1. Установите на сервере [Node.js](https://nodejs.org/en/download).
2. Распакуйте содержимое "who_master_YYYYMMDD.HHMM.zip" в желаемую директорию.
3. Создайте в этой директории файл с именем ".env", указав необходимые параметры.
4. Запустите CLI (например Cmd.exe) и перейдите к директории с приложением.
5. Выполните команду `npm install` и дождитесь загрузки библиотек.
6. Создайте базу данных командой `node who update`.
7. Запустите приложение командой `node who start`.
8. Войдите под временной учеткой (логин и пароль "admin"), добавьте роли и назначьте их пользователям.

### Команды для управления приложением

- `node who start` - запустить;
- `node who restart` - перезапустить;
- `node who stop` - завершить;
- `node who update` - создать/обновить базу данных;

### Обновление приложения

В большинстве случаев для обновления достаточно распаковать архив с актуальной версией в директорию приложения с заменой файлов и выполнить команду `node who restart`. Если были добавлены новые модули, то необходимо перенастроить роли чтобы они стали доступны пользователям. Если были внесены изменения в файл ".env", то для того чтобы изменения встпили в силу необходимо завершить работу приложения командой `node who stop`, после чего снова запустить командой `node who start`.

## Разработка

1. Установите на компьютере [Node.js](https://nodejs.org/en/download) и [Git](https://git-scm.com/download).
2. Создайте директорию для проекта и создайте в ней файл с именем ".env", указав необходимые параметры.
3. Запустите CLI (например Cmd.exe) и перейдите к созданной ранее директории.
4. Выполните команду `git clone https://github.com/hareharu/node-hospital.git`.
5. Выполните команду `npm install` и дождитесь загрузки библиотек (загрузка может занять несколько минут).

### Команды для среды разработки

- `npm run server` - запустить сервер в режиме разработки;
- `npm run client` - запустить клиент в режиме горячей перезагрузки;
- `npm run start` - запустить клиент и сервер параллельно в одном терминале;
- `npm run update` - запустить процесс создания/обновления базы данных;
- `npm run build` - собрать клиент для раздачи его сервером в статическом режиме;
- `npm run packapp` - упаковать приложение в архив для развертывания;
- `npm run clean` - удалить все созданные ранее архивы и директорию "dist";

### Сборка приложения для развертывания

Выполните последовательно команды `npm run build` и `npm run packapp`. После завершения упаковки в директории "dist" будет создан архив "who_custom_YYYYMMDD.XX.zip" со всем необходимым для работы приложения (кроме библиотек компонентов). В случае работы не под ОС Windows для выполнения упаковки предварительно установите [PowerShell Core](https://github.com/PowerShell/PowerShell).

### Полезные ссылки

- [Visual Studio Code](https://code.visualstudio.com/) - среда разработки со всем необходимым для работы;
- [DB Browser for SQLite](https://sqlitebrowser.org/) - компактный менеджер для SQLite баз данных;
- [DBeaver](https://dbeaver.io/) - менеджер баз данных поддерживающий Firebird, PostgreSQL и SQLite;

## Параметры для ".env" файла

Чтобы задать параметр укажите в файле имя параметра и значение отделив их знаком "=". Значения не нужно обрамлять кавычками. Например, `PORT=2308`. У части параметров есть значения по умолчанию, которые будут использованы в случае отсутствия параметра в файле.

### Основные параметры

- `PORT` - порт прослушиваняи для приложения; обязательный параметр!;
- `SECRET` - Ключ для подписи сессий и их проверки; обязательный параметр!;
- `INSTANCES` - количество запускаемых в кластере приложений; по умолчанию `4`;
- `MAXMEMORY` - максимальный объем памяти (в мегабайтах) при достижении которого приложение будет перезапущено; по умолчанию `250`;
- `PROXY` - адрес прокси-сервера; требуется для корректного определения адресов клиентов расположенных за прокси;
- `APPNAME` - имя приложения для сессий и менеджера процессов pm2; по умолчанию `node-hospital`;

### База данных МИС Госпиталь

- `PGH_HOST` - хост для доступа к серверу PostgreSQL; по умолчанию `localhost`;
- `PGH_PORT` - порт для доступа к серверу PostgreSQL; по умолчанию `5430`;
- `PGH_BASE` - имя базы данных; по умолчанию `vguz`;
- `PGH_USER` - имя пользователя для подключения к базе данных;
- `PGH_PASS` - пароль для подключения к базе данных;

### База данных ИС Стационар

- `RST_HOST` - хост для доступа к серверу Firebird; по умолчанию `localhost`;
- `RST_PORT` - порт для доступа к серверу Firebird;
- `RST_BASE` - путь к базе данных на сервере; например, `C:\Program Files (x86)\kmiac\R_III.fdb`
- `RST_USER` - имя пользователя для подключения к базе данных
- `RST_PASS` - пароль для подключения к базе данных
- `RST_LOGS` - директория с журналами сервисов веб-Стационар; например, `C:\Program Files (x86)\kmiac\www\webST\protected\runtime`

### Единый информационный ресурс

- `EIR_HOST` - хост;
- `EIR_PORT` - порт;
- `EIR_USER` - имя пользователя учетной записи стационра на ЕИР;
- `EIR_PASS` - пароль;

### Сервис поиска данных застрахованных

- `RZN_HOST` - хост;
- `RZN_PORT` - порт;
- `RZN_USER` - имя пользователя учетной записи для личного кабинета МО
- `RZN_PASS` - пароль;

### [Обработчик реестров](https://github.com/hareharu/fproc-nodejs)

- `FPR_BASE` - путь к базе данных (только для десктопной версии);
- `FPR_HOST` - хост (для веб версии);
- `FPR_PORT` - порт (для веб версии);
- `FPR_APIKEY` - ключ API (если задан в параметрах веб версии);

### Дополнительные параметры для запуска в режиме разработки

- `PORT` - в режиме разработки этот параметр задает порт для клиента; по умолчанию `3000`;
- `DEV_PORT` - порт для сервера; по умолчанию `9000`;
- `DEV_LOG` - формат вывода для логгера morgan; допускаются [предустановленные](https://github.com/expressjs/morgan#predefined-formats) варианты, либо строка с [токенами](https://github.com/expressjs/morgan#tokens); по умолчанию `dev`;
- `DEV_PROXY` - перенаправление запросов клиента на сервер расположенный на другом компьютере; например: `http://192.168.1.2:7000`;
- `DEV_API` - вместо обращения к серверу часть запросов будут возвращать ответы из файлов в директории "json"; например: `all` или `rznsoap`;

## Описание модулей

### Доступ без авторизации

#### HBookMKB – Справочник МКБ
- .
#### KMIACVideo – Видеоконференции
- Отображение видеоконференций из расписания с сайта ККМИАЦ с возможностью фильтрации по участникам.
#### PhoneBook - Телефонный справочник
- Простой телефонный справочник с возможностью разделения записей на группы.
#### VideoArchive - Архив видеороликов
- Стриминг видео файлов (.mkv, .mov, .mp4). Файлы можно либо добавить индивидуально, либо брать из заданной папки (подпапки будут использованы в качестве категорий).

### Доступ для ролей Пользователи

#### Diagnosis – Диагнозы
- Отчет по выставленным МКБ из МИС Госпиталь.
#### FProcExam - Реестры ДД и ПО
- Отчет Обработчика реестров по подаче реестров ДД и ПО с разбивкой по филиалам.
#### FProcSend - Информационный обмен
- Отчет по отправке фалов Обработчиком реестров.
#### Hardware – Оборудование
- Учет оборудования.
#### HomeLinks - Домашняя страница
- Настройка ссылок на домашней странице.
#### MyIssues - Мои задачи
- Просмотр созданных пользователем задач.
#### NewsBoard - Новости и объявления
- Редактирование новостей и объявлений для главной страницы.
#### ReestrAPP – Посещения
- Отчет по случаям АПП из МИС Госпиталь с разбивкой по врачам.
#### ReestrExam – Профосмотры
- Отчет по случаям ДД и ПО из МИС Госпиталь с разбивкой по врачам.
#### ReestrInfo - Информация по реестрам
- Отчет по состоянию оплаты реестров из МИС Госпиталь
#### ReportAPP - Отчеты АПП
- Формирования отчетов из папки “report”.
#### Schedule - Расписание приема
- Просмотр расписания из МИС Госпиталь и создание таблицы для печати / сайта.
#### Templates - Шаблоны документов
- Редактирование шаблонов документов для модуля “Пациенты”.

### Доступ для ролей Медработники

#### Ambulance - Мониторинг СМП
- Отчет по вызовам СМП из ИС Стационар.
#### Cancer - Реестры по онкологии
- Отчет по случаям с выставленными онкологическими диагнозами и подозрениями на них из МИС Госпиталь.
#### EIRQueue - Очередь на ЕИР
- Вывод в нормальном виде очереди на госпитализацию с ЕИР.
#### Epicrisis - Выписные эпикризы
- Просмотр выписных эпикризов загруженных в МИС Госпиталь.
#### FProcArchive - Архив реестров ОМС
- Поиск по реестрам обработанным Обработчиком реестров.
#### Patient – Пациенты
- Вывод информации по пациентам из МИС Госпиталь.
#### SearchRZN - Поиск в РЗН
- Поиск в регистре застрахованных ТФОМС.

### Доступ для ролей Администраторы

#### Import - Импорт данных
- Импорт информации в справочники системы из .csv файлов.
#### IssueTracker - Работа с задачами
- Простая с управления инцидентами. Данный модуль предназначен для распределения задач между исполнителями и отслеживания выполнения.
#### Kanban - Канбан-доска
- Просты доски для учета задач. Помимо доски в которую будут добавлять задачи назначенные из модуля “Работа с задачами” возможно создать дополнительные доски для личного использования.
#### Passwords - Хранилище паролей
- WIP
#### PMonitor - Мониторинг приложений
- Мониторинг работы системы. Просмотр авторизированных пользователей, логов.
#### QueryDB - Запросы к БД
- WIP. В целом модуль работоспособен, но из предыдущего варианта не перенесена система подстановки переменных в запросы.
#### References – Справочники
- Работа со справочниками системы.
#### ServiceLog - Журналы сервисов
- Просмотр некоторых  логов МИС Госпиталь и ИС Стационар.
#### Settings – Параметры
- Настройки системы.
#### UserRoles - Роли и пользователи
- Редактирование пользователей, настройка меню для ролей. Имеется возможность привязки ролей к пользователям из МИС Госпиталь. Привязка ролей к пользователям из AD не доработана.
